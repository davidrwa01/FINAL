# Activity History & Tracking System Implementation

## Overview
Complete activity history tracking system has been implemented to record all user actions in the SMART-KORAFX platform.

## Components Created

### 1. **Activity Model** (`backend/models/Activity.js`)
- Comprehensive activity logging schema
- Auto-expires records after 90 days for GDPR compliance
- Tracks 20+ action types: LOGIN, LOGOUT, REGISTER, SIGNAL_GENERATED, SUBSCRIPTION_CREATED, etc.
- Stores detailed information including signal data, subscription data, IP address, user agent
- Static methods for logging and retrieving activities
- Automatic TTL index for data lifecycle management

**Key Features:**
- `logActivity()` - Static method to log any user action
- `getUserHistory()` - Retrieve filtered activity history with pagination
- `getUserActivityStats()` - Get activity summary statistics

### 2. **Activity Logger Middleware** (`backend/middleware/activityLogger.js`)
- `activityLogger` - Middleware that injects `req.logActivity()` method on every request
- `withActivityLogging` - Wrapper for creating activity-logging route handlers
- Automatic IP and user-agent tracking
- Non-blocking logging (doesn't break main request flow if logging fails)

### 3. **History API Routes** (`backend/routes/history.js`)
Five main endpoints implemented:

#### `GET /api/history` - General Activity History
- Retrieve user's complete activity history
- Query parameters: `limit`, `page`, `actionType`, `startDate`, `endDate`, `status`
- Pagination support (max 100 per page)
- Response includes total count and pages

#### `GET /api/history/stats` - Activity Statistics
- Get summary statistics for a time period
- Query parameter: `days` (default 30, max 365)
- Groups activities by action type with counts

#### `GET /api/history/signals` - Signal Generation History
- Specialized endpoint for signal tracking
- Filters for SIGNAL_GENERATED actions only
- Shows all trading signals generated by user

#### `GET /api/history/logins` - Login History
- Track all login events
- Useful for security monitoring
- Includes IP and user-agent information

#### `GET /api/history/subscriptions` - Subscription History
- Track subscription creation, approvals, and rejections
- Shows payment amounts and transaction IDs

#### `GET /api/history/security` - Security Events
- Monitors password changes, failed logins, unauthorized access attempts
- Security audit trail

### 4. **Activity Logging Added To Routes**

#### Authentication Routes (`backend/routes/auth.js`)
- `REGISTER` - Logged when user creates account
- `LOGIN` - Logged on successful login
- `LOGOUT` - Logged before session destruction
- `PROFILE_UPDATE` - Logged with update details
- `PASSWORD_CHANGE` - Logged when user changes password
- `PASSWORD_RESET` - Logged when user resets password via OTP

#### Signal Routes (`backend/routes/signals.js`)
- `SIGNAL_GENERATED` - Logged for every signal generation
  - Includes symbol, timeframe, direction, confidence
  - Tracks subscription type (PREMIUM vs TRIAL)
  - Tracks failed attempts if trial limit exceeded

#### Subscription Routes (`backend/routes/subscription.js`)
- `SUBSCRIPTION_CREATED` - Logged when user submits payment
  - Includes plan tier, amount, transaction ID

### 5. **Server Configuration** (`backend/server.js`)
- Activity logger middleware registered globally
- History routes mounted at `/api/history`
- All authenticated routes can now use `req.logActivity()`

### 6. **Frontend ScanHistory Component Updated** (`frontend/src/components/profile/ScanHistory.jsx`)
- **Dynamic Data Fetching**: Fetches from `/api/history/signals` endpoint
- **Real-time Filtering**: Filters by signal type, trading pair, date range
- **Live Statistics**: Calculates total scans, this week stats, win rate
- **Loading States**: Shows spinner while fetching data
- **Error Handling**: Graceful error display with user-friendly messages
- **Responsive Design**: Mobile and desktop layouts
- **Empty States**: Helpful messages when no data available

## Usage Examples

### Log a Custom Activity
```javascript
// In any route handler with req
await req.logActivity('CUSTOM_ACTION', {
  description: 'User did something',
  details: { customData: 'value' },
  status: 'SUCCESS'
});
```

### Fetch User's Activity History
```javascript
// From frontend
const response = await fetch('/api/history?limit=50&page=1&actionType=SIGNAL_GENERATED', {
  credentials: 'include'
});
const { data } = await response.json();
console.log(data.activities); // Array of activities
```

### Query Signal History
```javascript
// Get all signals generated
const response = await fetch('/api/history/signals?limit=100', {
  credentials: 'include'
});
```

### Get Login Security Audit Trail
```javascript
// Security monitoring
const response = await fetch('/api/history/logins?limit=20', {
  credentials: 'include'
});
```

## Data Stored Per Activity

Each activity record contains:
```javascript
{
  _id: ObjectId,
  userId: ObjectId,
  actionType: String, // One of 20+ types
  description: String,
  details: Object,
  signalData: {
    symbol: String,
    timeframe: String,
    direction: String,
    confidence: Number,
    entry: Number,
    stopLoss: Number,
    takeProfit: Number
  },
  subscriptionData: {
    planId: ObjectId,
    planTier: String,
    amount: Number,
    transactionId: String
  },
  ipAddress: String,
  userAgent: String,
  status: String, // SUCCESS, FAILED, PENDING
  errorMessage: String,
  sessionId: String,
  createdAt: Date // Auto-expires after 90 days
}
```

## Security Features

✅ **Access Control**: Only authenticated users can view their own history
✅ **Data Privacy**: Activities auto-delete after 90 days
✅ **Audit Trail**: IP address and user-agent recorded for security monitoring
✅ **Error Tracking**: Failed actions logged with error messages
✅ **Session Tracking**: Session IDs recorded for session correlation

## Frontend Integration

The ScanHistory component now:
1. Fetches real signal generation activities on mount
2. Transforms Activity records into display format
3. Applies dynamic filtering (signal type, pair, date range)
4. Calculates real statistics from data
5. Shows loading/error states
6. Displays empty state with helpful message

## API Response Format

### Success Response
```json
{
  "success": true,
  "data": {
    "activities": [
      {
        "_id": "...",
        "actionType": "SIGNAL_GENERATED",
        "description": "Signal generated for BTCUSDT on 1h",
        "signalData": {...},
        "createdAt": "2026-02-04T12:00:00Z"
      }
    ],
    "total": 50,
    "page": 1,
    "limit": 50,
    "pages": 1
  }
}
```

### Error Response
```json
{
  "success": false,
  "error": "SERVER_ERROR",
  "message": "Error fetching activity history"
}
```

## Next Steps (Optional Enhancements)

1. **Admin Dashboard**: View all users' activities (add to admin routes)
2. **Signal Result Tracking**: Add WIN/LOSS/PENDING tracking to signals
3. **Activity Webhooks**: Send webhooks for certain events
4. **Export History**: CSV/PDF export functionality
5. **Real-time Notifications**: Push notifications for important events
6. **Activity Filtering UI**: More advanced filtering in history view

## Testing Checklist

- [ ] User registers → Check `REGISTER` activity logged
- [ ] User logs in → Check `LOGIN` activity with correct IP
- [ ] User generates signal → Check `SIGNAL_GENERATED` with signal details
- [ ] User changes password → Check `PASSWORD_CHANGE` activity
- [ ] User updates profile → Check `PROFILE_UPDATE` with changed fields
- [ ] User submits subscription → Check `SUBSCRIPTION_CREATED` activity
- [ ] Access `/api/history` → See paginated activity list
- [ ] Filter by action type → See filtered results
- [ ] View profile history tab → See real signal generation history
- [ ] Check 90-day TTL → Verify old records are deleted

## Files Modified

1. `/backend/models/Activity.js` - NEW
2. `/backend/middleware/activityLogger.js` - NEW
3. `/backend/routes/history.js` - NEW
4. `/backend/server.js` - Updated (added middleware and routes)
5. `/backend/routes/auth.js` - Updated (added logging)
6. `/backend/routes/signals.js` - Updated (added logging)
7. `/backend/routes/subscription.js` - Updated (added logging)
8. `/frontend/src/components/profile/ScanHistory.jsx` - Updated (real data fetching)

---

**Status**: ✅ Complete - Ready for testing and production deployment
